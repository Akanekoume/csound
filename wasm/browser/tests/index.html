<!DOCTYPE html>
<html>
  <head>
    <title>testin @csound/browser</title>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
  </head>
  <body>
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script>
      window.assert = chai.assert;
    </script>
    <div id="mocha"></div>
    <script type="module">
      const url = "/libcsound.dev.mjs";
      const helloWorld = `
      <CsoundSynthesizer>
        <CsOptions>
          -odac
        </CsOptions>
        <CsInstruments>
          instr 1
          prints "Hello World!\n"
          endin
        </CsInstruments>
        <CsScore>
          i 1 0 0
        </CsScore>
      </CsoundSynthesizer>
      `;
      const shortTone = `
      <CsoundSynthesizer>
        <CsOptions>
          -odac
        </CsOptions>
        <CsInstruments>
          0dbfs = 1

          chnset(1, "test1")
          chnset(2, "test2") 

          instr 1
          out poscil(0dbfs/3, 440) * linen:a(1, .01, p3, .01)
          endin
        </CsInstruments>
        <CsScore>
          i 1 0 1
        </CsScore>
      </CsoundSynthesizer>
      `;

      const shortTone2 = `
      <CsoundSynthesizer>
        <CsOptions>
          -odac
        </CsOptions>
        <CsInstruments>
          0dbfs = 1

          chnset(440, "freq")

          instr 1
          out poscil(0dbfs/3, chnget:k("freq")) * linen:a(1, .01, p3, .01)
          endin
        </CsInstruments>
        <CsScore>
          i 1 0 1
        </CsScore>
      </CsoundSynthesizer>
      `;


      const stringChannelTest = `
      <CsoundSynthesizer>
        <CsOptions>
          -odac
        </CsOptions>
        <CsInstruments>
          0dbfs = 1

          chnset("test0", "strChannel")

        </CsInstruments>
        <CsScore>
          i 1 0 1
        </CsScore>
      </CsoundSynthesizer>
      `;

      mocha.setup("bdd").fullTrace();
      describe("@csound/browser", async () => {
        /*
      it("has correct API", async () => {
      console.log("sanity");
      const { Csound } = await import(url);
      const csoundObj = await Csound();
      console.log("returns?", csoundObj);
      assert.property(csoundObj, "start", "has .start() method");
      assert.property(csoundObj, "stop", "has .stop() method");
      assert.property(csoundObj, "pause", "has .pause() method");
      assert.property(csoundObj, "pause", "has .pause() method");
      assert.property(csoundObj, "setMessageCallback", "has .setMessageCallback() method");
      });

      */

      const useWorker = true;

      it("can be started", async function () {
      this.timeout(10000);
      const { Csound } = await import(url);
      const csoundObj = await Csound({useWorker});
      const startReturn = await csoundObj.start();
      assert.equal(startReturn, 0);
      csoundObj.reset();
      });

      it("can use just compileOrc", async function () {
      this.timeout(10000);
      const { Csound } = await import(url);
      const csoundObj = await Csound({useWorker});
      await csoundObj.compileOrc(`
      ksmps=64
      instr 1 
        out oscili(.25, 110)
      endin
      schedule(1,0,1)
      `)
      const startReturn = await csoundObj.start();
      assert.equal(startReturn, 0);
      csoundObj.reset();
      });
        it("can play tone and get channel values", async function () {
          this.timeout(10000);
          const { Csound } = await import(url);
          const csoundObj = await Csound({useWorker});
          const compileReturn = await csoundObj.compileCsdText(shortTone);
          assert.equal(compileReturn, 0);
          const startReturn = await csoundObj.start();
          assert.equal(startReturn, 0);
          assert.equal(1, await csoundObj.getControlChannel("test1"));
          assert.equal(2, await csoundObj.getControlChannel("test2"));
          setTimeout(() => csoundObj.reset(), 1000);
        });

        it("can play tone and send channel values", async function () {
          this.timeout(10000);
          const { Csound } = await import(url);
          const csoundObj = await Csound({useWorker});
          const compileReturn = await csoundObj.compileCsdText(shortTone2);
          assert.equal(compileReturn, 0);
          const startReturn = await csoundObj.start();
          assert.equal(startReturn, 0);
          await csoundObj.setControlChannel("freq", 880);
          assert.equal(880, await csoundObj.getControlChannel("freq"));
        });

        it("can send and receive string channel values", async function () {
          this.timeout(10000);
          const { Csound } = await import(url);
          const csoundObj = await Csound({useWorker});

          console.log(csoundObj);
          const compileReturn = await csoundObj.compileCsdText(stringChannelTest);
          assert.equal(compileReturn, 0);
          const startReturn = await csoundObj.start();
          assert.equal(startReturn, 0);
          console.log(await csoundObj.getStringChannel("strChannel"))
          assert.equal("test0", await csoundObj.getStringChannel("strChannel"));
          await csoundObj.setStringChannel("strChannel", "test1");
          assert.equal("test1", await csoundObj.getStringChannel("strChannel"));
        });
      });

      const triggerEvent = "ontouchstart" in document.documentElement ? "touchend" : "click";
      document.querySelector("#all_tests").addEventListener(triggerEvent, async function () {
        mocha.run();
      });
    </script>
    <button id="all_tests">Run All Tests</button>
  </body>
</html>
